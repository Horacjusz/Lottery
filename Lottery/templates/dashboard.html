<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel uÅ¼ytkownika</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="dashboard-container">
        <h2>Witaj, {{ username }}!</h2>
        <p>Witamy w Twoim panelu uÅ¼ytkownika. Tutaj moÅ¼esz zarzÄ…dzaÄ‡ swoim kontem, zobaczyÄ‡ listÄ™ Å¼yczeÅ„ oraz rozpoczÄ…Ä‡ losowanie.</p>

        <div class="section">
            <h3>Rozpocznij losowanie</h3>
            <a href="#" class="dashboard-link">Rozpocznij losowanie</a>
        </div>

        <!-- Sekcja listy Å¼yczeÅ„ -->
        <div class="section">
            <h3>Twoja lista Å¼yczeÅ„:</h3>
            <table class="wishlist-table">
                <tbody>
                    {% for item in wishlist %}
                        <tr data-item="{{ item.name }}">
                            <td>
                                <span class="item-name">{{ item.name }}</span>
                                <span class="item-description">{{ item.description }}</span>
                            </td>
                            <td><span class="edit-icon" onclick="editItem(event, '{{ item.name }}', '{{ item.description }}')">âœŽ</span></td>
                            <td><span class="remove-icon" onclick="removeItem(event, '{{ item.name }}')">Ã—</span></td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>

            <!-- Formularz dodawania nowego Å¼yczenia -->
            <form id="wishlist-form">
                <h4>Dodaj przedmiot</h4>
                <input type="text" id="wishlist_item" name="wishlist_item" placeholder="Nazwa przedmiotu" required>
                <input type="text" id="wishlist_description" name="wishlist_description" placeholder="Opis przedmiotu">
                <button type="submit">Dodaj</button>
            </form>
        </div>

        <div class="section">
            <a href="{{ url_for('logout') }}" class="dashboard-link logout">Wyloguj siÄ™</a>
        </div>
    </div>

    <script>
        function editItem(event, itemName, itemDescription) {
            event.preventDefault();
            event.stopPropagation();

            // ZnajdÅº wiersz i komÃ³rki do edycji
            const row = event.target.closest("tr");
            const nameCell = row.querySelector(".item-name");
            const descCell = row.querySelector(".item-description");

            // UtwÃ³rz pola tekstowe dla edycji
            nameCell.innerHTML = `<input type="text" value="${itemName}" class="edit-name">`;
            descCell.innerHTML = `<input type="text" value="${itemDescription}" class="edit-description">`;

            // Dodaj osobnÄ… komÃ³rkÄ™ dla ikony zapisu
            const editIconCell = row.querySelector(".edit-icon").parentElement;
            editIconCell.innerHTML = `<span class="save-icon" onclick="saveItem(event, '${itemName}')">ðŸ’¾</span>`;
        }

        function saveItem(event, originalName) {
            event.preventDefault();
            event.stopPropagation();

            // Pobierz wiersz, nowe wartoÅ›ci z pÃ³l tekstowych
            const row = event.target.closest("tr");
            const newName = row.querySelector(".edit-name").value;
            const newDescription = row.querySelector(".edit-description").value;

            // Logowanie do konsoli dla debugowania
            console.log("WysyÅ‚anie danych do serwera:", { originalName, newName, newDescription });

            // WyÅ›lij zmienione dane na serwer
            fetch("{{ url_for('edit_wishlist_item') }}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ original_name: originalName, new_name: newName, new_description: newDescription })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Zaktualizuj komÃ³rki z nowymi wartoÅ›ciami
                    row.querySelector(".item-name").innerText = newName;
                    row.querySelector(".item-description").innerText = newDescription;

                    // PrzywrÃ³Ä‡ ikonÄ™ edycji zamiast ikony zapisu
                    const saveIconCell = row.querySelector(".save-icon").parentElement;
                    saveIconCell.innerHTML = `<span class="edit-icon" onclick="editItem(event, '${newName}', '${newDescription}')">âœŽ</span>`;
                } else {
                    alert(data.error || "WystÄ…piÅ‚ bÅ‚Ä…d podczas zapisywania zmian.");
                }
            })
            .catch(error => console.error("BÅ‚Ä…d:", error));
        }


        function removeItem(event, item) {
            event.preventDefault();
            event.stopPropagation();

            fetch("{{ url_for('remove_wishlist_item') }}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ wishlist_item: item })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const row = document.querySelector(`tr[data-item="${item}"]`);
                    if (row) {
                        row.remove();
                    }
                } else {
                    alert(data.error || "WystÄ…piÅ‚ bÅ‚Ä…d podczas usuwania przedmiotu.");
                }
            })
            .catch(error => console.error("BÅ‚Ä…d:", error));
        }

        document.getElementById("wishlist-form").addEventListener("submit", function(e) {
            e.preventDefault();
            const wishlistItem = document.getElementById("wishlist_item").value;
            const wishlistDescription = document.getElementById("wishlist_description").value;

            fetch("{{ url_for('add_wishlist_item') }}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ wishlist_item: wishlistItem, wishlist_description: wishlistDescription })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const tableBody = document.querySelector(".wishlist-table tbody");
                    const newRow = document.createElement("tr");
                    newRow.setAttribute("data-item", data.item);

                    newRow.innerHTML = `
                        <td>
                            <span class="item-name">${data.item}</span>
                            <span class="item-description">${data.description}</span>
                        </td>
                        <td><span class="edit-icon" onclick="editItem(event, '${data.item}', '${data.description}')">âœŽ</span></td>
                        <td><span class="remove-icon" onclick="removeItem(event, '${data.item}')">Ã—</span></td>
                    `;

                    tableBody.appendChild(newRow);
                    document.getElementById("wishlist_item").value = "";
                    document.getElementById("wishlist_description").value = "";
                } else {
                    alert(data.error || "WystÄ…piÅ‚ bÅ‚Ä…d podczas dodawania przedmiotu.");
                }
            })
            .catch(error => console.error("BÅ‚Ä…d:", error));
        });
    </script>
</body>
</html>

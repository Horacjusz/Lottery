<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel użytkownika</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="dashboard-container">
        <h2>Witaj, {{ username }}!</h2>
        <p>Witamy w Twoim panelu użytkownika. Tutaj możesz zarządzać swoim kontem, zobaczyć listę życzeń oraz rozpocząć losowanie.</p>

        <div class="section">
            <h3>Losowanie</h3>
        
            {% if assigned_user is not none %}
                <!-- If an assignment exists, display the assigned user's information in a two-column table -->
                <div class="assigned-user-info">
                    <p>Wylosowałeś: <strong>{{ assigned_user.name }}</strong></p>
                    <h4>Lista życzeń:</h4>
                    <table class="wishlist-table" id="assigned-user-wishlist">
                        <tbody>
                            {% for item in assigned_user.wishlist %}
                                <tr class="{% if item.reserved_by == user_id %}reserved-item{% endif %}" data-item="{{ item.name }} - {{ item.description }}">
                                    <td>
                                        <span class="item-name">{{ item.name }}</span>
                                        <span class="item-description">{{ item.description }}</span>
                                    </td>
                                    <td>
                                            <span class="approve-icon" onclick="acceptItem(event, '{{ assigned_user.username }}', '{{ item.name|escape }}', '{{ item.description|escape }}')">
                                                {% if item.reserved_by == user_id %}×{% else %}✔{% endif %}
                                            </span>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    </table>
                </div>
            {% elif not user_data.choosable %}
                <!-- If choosable is False and assignment is None, display a message -->
                <p>Ty nie losujesz</p>
            {% else %}
                <!-- If assignment is None and choosable is True, display the draw button -->
                <button id="draw-button" onclick="startDraw()">Rozpocznij losowanie</button>
                <div id="draw-result"></div>
            {% endif %}
        </div>
        

        <div class="section">
            <h3>Twoja lista życzeń:</h3>
            <p id="no-items" {% if wishlist and wishlist|length > 0 %}style="display: none;"{% endif %}>Nic tu jeszcze nie ma</p>
            <table class="wishlist-table" id="wishlist-table">
                <tbody>
                    {% for item in wishlist %}
                        <tr data-item="{{ item.name }} - {{ item.description }}">
                            <td>
                                <span class="item-name">{{ item.name }}</span>
                                <span class="item-description">{{ item.description }}</span>
                            </td>
                            <td><span class="edit-icon" onclick="editItem(event, '{{ item.name|escape }}', '{{ item.description|escape }}')">✎</span></td>
                            <td><span class="remove-icon" onclick="removeItem(event, '{{ item.name|escape }}', '{{ item.description|escape }}')">×</span></td>
                        </tr>
                    {% endfor %}

                </tbody>
            </table>

            <form id="wishlist-form">
                <h4>Dodaj przedmiot</h4>
                <input type="text" id="wishlist_item" name="wishlist_item" placeholder="Nazwa przedmiotu" required>
                <input type="text" id="wishlist_description" name="wishlist_description" placeholder="Opis przedmiotu">
                <button type="submit">Dodaj</button>
            </form>
        </div>

        <div class="section">
            <h3>Twoje zarezerwowane przedmioty:</h3>
            <p id="no-reserved-items" {% if reserved_items and reserved_items|length > 0 %}style="display: none;"{% endif %}>Nie zarezerwowałeś jeszcze żadnych przedmiotów.</p>
            <table class="wishlist-table" id="reserved-table">
                <tbody>
                    {% for item in reserved_items %}
                        <tr class="reserved-item" data-item="{{ item.name }} - {{ item.description }}">
                            <td>
                                <span class="item-name">{{ item.name }}</span>
                                <span class="item-description">{{ item.description }}</span>
                                <span class="item-owner">{{ item.owner_name }}</span>
                            </td>
                            <td><span class="remove-icon" onclick="unreserveItem(event, '{{ item.name|escape }}', '{{ item.description|escape }}', '{{ item.owner_username|escape }}')">×</span></td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>


        <div class="section">
            <a href="{{ url_for('user_list') }}" class="dashboard-link">Lista Użytkowników</a>
        </div>

        <div class="section">
            <a href="{{ url_for('verify_password') }}" class="dashboard-link">Edytuj dane użytkownika</a>
        </div>

        <div class="section">
            <a href="{{ url_for('logout') }}" class="dashboard-link logout">Wyloguj się</a>
        </div>
    </div>

    <script>
        function acceptItem(event, username, itemName, itemDescription) {
            const iconElement = event.target;
            const row = iconElement.closest("tr");
            
            fetch("{{ url_for('reserve_wishlist_item') }}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    username: username,
                    item_name: itemName,
                    item_description: itemDescription
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Toggle the row and icon immediately
                    row.classList.toggle("reserved-item");
                    if (iconElement.classList.contains("reserved-icon")) {
                        iconElement.classList.remove("reserved-icon");
                        iconElement.textContent = "✔"; // Change to check mark
                    } else {
                        iconElement.classList.add("reserved-icon");
                        iconElement.textContent = "×"; // Change to cross mark
                    }
                } else {
                    alert(data.error || "Error reserving item.");
                }
            })
            .catch(error => {
                console.error("Error:", error);
                alert("Error processing reservation request.");
            });
        }
    
        function startDraw() {
            fetch("{{ url_for('start_draw') }}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                }
            })
            .then(response => response.json())
            .then(data => {
                const drawResultDiv = document.getElementById("draw-result");
                if (data.success) {
                    drawResultDiv.innerHTML = `
                        <p>Wylosowałeś: <strong>${data.name}</strong></p>
                        <h4>Lista życzeń:</h4>
                        <table class="wishlist-table">
                            <tbody>
                                ${data.wishlist.map(item => `
                                    <tr>
                                        <td><span class="item-name">${item.name}</span> - <span class="item-description">${item.description}</span></td>
                                        <td><button class="accept-button" onclick="acceptItem('${item.name}', '${item.description}')">Akceptuj</button></td>
                                    </tr>
                                `).join("")}
                            </tbody>
                        </table>
                    `;
                    document.getElementById("draw-button").style.display = "none";
                } else {
                    drawResultDiv.innerHTML = `<p>${data.error || "Wystąpił błąd podczas losowania."}</p>`;
                }
            })
            .catch(error => {
                console.error("Error:", error);
                document.getElementById("draw-result").innerHTML = "<p>Wystąpił błąd podczas losowania.</p>";
            });
        }

        function startDraw() {
            fetch("{{ url_for('start_draw') }}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                }
            })
            .then(response => response.json())
            .then(data => {
                const drawResultDiv = document.getElementById("draw-result");
                if (data.success) {
                    // Wyświetlenie wyniku losowania
                    drawResultDiv.innerHTML = `
                        <p>Wylosowałeś: <strong>${data.name}</strong></p>
                        <h4>Lista życzeń:</h4>
                        <ul>
                            ${data.wishlist.map(item => `<li>${item.name} - ${item.description}</li>`).join("")}
                        </ul>
                    `;
                    document.getElementById("draw-button").style.display = "none";
                } else {
                    // Wyświetlenie komunikatu o błędzie
                    drawResultDiv.innerHTML = `<p>${data.error || "Wystąpił błąd podczas losowania."}</p>`;
                }
            })
            .catch(error => {
                console.error("Error:", error);
                document.getElementById("draw-result").innerHTML = "<p>Wystąpił błąd podczas losowania.</p>";
            });
        }
        // Function to unreserve an item and update the reserved items section
        function unreserveItem(event, itemName, itemDescription, ownerName) {
            const itemRow = document.querySelector(`tr[data-item="${itemName} - ${itemDescription}"]`);

            fetch("{{ url_for('reserve_wishlist_item') }}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    username: ownerName,
                    item_name: itemName,
                    item_description: itemDescription
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remove the item row immediately
                    if (itemRow) {
                        itemRow.remove();
                    }

                    // Check if any items are left in the reserved table and toggle the message visibility
                    const reservedTableBody = document.querySelector("#reserved-table tbody");
                    const noReservedItemsMessage = document.getElementById("no-reserved-items");

                    if (!reservedTableBody.querySelector("tr")) {
                        noReservedItemsMessage.style.display = "block";  // Show message if no items remain
                    }
                }
            })
            .catch(error => {
                console.error("Error:", error);  // Log error silently
            });
        }
    

        function editItem(event, itemName, itemDescription) {
            event.preventDefault();
            event.stopPropagation();

            const row = event.target.closest("tr");
            const nameCell = row.querySelector(".item-name");
            const descCell = row.querySelector(".item-description");

            nameCell.innerHTML = `<input type="text" value="${itemName}" class="edit-name">`;
            descCell.innerHTML = `<input type="text" value="${itemDescription}" class="edit-description">`;

            const editIconCell = row.querySelector(".edit-icon").parentElement;
            editIconCell.innerHTML = `<span class="save-icon" onclick="saveItem(event, '${itemName}', '${itemDescription}')">💾</span>`;
        }

        function saveItem(event, originalName, originalDescription) {
            event.preventDefault();
            event.stopPropagation();

            const row = event.target.closest("tr");
            const newName = row.querySelector(".edit-name").value;
            const newDescription = row.querySelector(".edit-description").value;

            fetch("{{ url_for('edit_wishlist_item') }}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    original_name: originalName,
                    original_description: originalDescription,
                    new_name: newName,
                    new_description: newDescription
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    row.querySelector(".item-name").innerText = newName;
                    row.querySelector(".item-description").innerText = newDescription;

                    const saveIconCell = row.querySelector(".save-icon").parentElement;
                    saveIconCell.innerHTML = `<span class="edit-icon" onclick="editItem(event, '${newName}', '${newDescription}')">✎</span>`;
                } else {
                    alert(data.error || "Error saving changes.");
                }
            })
            .catch(error => console.error("Error:", error));
        }

        function removeItem(event, itemName, itemDescription) {
            event.preventDefault();
            event.stopPropagation();

            fetch("{{ url_for('remove_wishlist_item') }}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ wishlist_item: itemName, wishlist_description: itemDescription })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const row = document.querySelector(`tr[data-item="${itemName} - ${itemDescription}"]`);
                    if (row) {
                        row.remove();
                    }
                    
                    // Check if the wishlist is now empty
                    const tableBody = document.querySelector(".wishlist-table tbody");
                    if (tableBody.children.length === 0) {
                        document.getElementById("no-items").style.display = "block";
                    }
                } else {
                    alert(data.error || "Error removing item.");
                }
            })
            .catch(error => console.error("Error:", error));
        }

        // Update to hide the "No items" message on adding an item
        document.getElementById("wishlist-form").addEventListener("submit", function(e) {
            e.preventDefault();
            const wishlistItem = document.getElementById("wishlist_item").value;
            const wishlistDescription = document.getElementById("wishlist_description").value;

            fetch("{{ url_for('add_wishlist_item') }}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    wishlist_item: wishlistItem,
                    wishlist_description: wishlistDescription
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const tableBody = document.querySelector(".wishlist-table tbody");
                    const newRow = document.createElement("tr");
                    newRow.setAttribute("data-item", `${data.item} - ${data.description}`);

                    newRow.innerHTML = `
                        <td>
                            <span class="item-name">${data.item}</span>
                            <span class="item-description">${data.description}</span>
                        </td>
                        <td><span class="edit-icon" onclick="editItem(event, '${data.item}', '${data.description}')">✎</span></td>
                        <td><span class="remove-icon" onclick="removeItem(event, '${data.item}', '${data.description}')">×</span></td>
                    `;

                    tableBody.appendChild(newRow);

                    document.getElementById("wishlist_item").value = "";
                    document.getElementById("wishlist_description").value = "";
                    document.getElementById("no-items").style.display = "none";  // Hide "No items" message
                } else {
                    alert(data.error || "Error adding item to wishlist.");
                }
            })
            .catch(error => console.error("Error:", error));
        });
    </script>
</body>
</html>
